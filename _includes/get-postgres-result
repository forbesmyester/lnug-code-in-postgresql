#!/bin/bash

UUID=$(uuidgen)
SQL_FILE="$(echo "$1" | sed 's/\.[a-z]*//').sql"
JS_FILE="$(echo "$1" | sed 's/\.[a-z]*//').js"
SQL_TMP=$(mktemp)
JS_TMP=$(mktemp)
echo $JS_FILE $SQL_FILE

echo "select(jsonb_agg(t)) from ( $(cat $SQL_FILE) ) t" | psql -t -z | jq -S -c '.[]' > "$SQL_TMP"
node "$JS_FILE" | jq -c -S . > "$JS_TMP"
diff "$JS_TMP" "$SQL_TMP"
E=$?
if [ $E -ne 0 ]; then
    echo "Difference detected..."
    echo "Files: $JS_TMP $SQL_TMP"
fi
exit $E
