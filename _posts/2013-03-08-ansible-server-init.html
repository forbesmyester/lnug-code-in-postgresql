---
layout: post
title: Ansible Server Init
tag: 
---

 <style>     pre {         margin: 1em;         background-color: #DDD;         padding: 0.5em;         border: 1px #AAA solid;     }      pre code {       padding: 0 0;     }      code {       background-color: #DDD;       padding: 0 0.3em;     }  </style> <h2 id="installing-a-development-server">Installing a Development Server</h2><p>Today I wanted to get started on writing the server code for SyncItStore so needed to set up a dev server. I started installing Ubuntu Server and was keeping notes on the steps I needed to replicated it.</p><p>I created virtual guests on my laptop using <a href="http://libvirt.org/">libvirt</a> backed by <a href="http://en.wikipedia.org/wiki/Logical_Volume_Manager_(Linux)">LVM</a> storage with a (Virtual Machine Manager)[http://virt-manager.org/] front end.</p><p>Installing <a href="http://www.ubuntu.com/">Ubuntu</a> is a breeze nowadays, I can nearly do it with my eyes closed, but it is the post release stuff that's a little trickier...</p><h2 id="deciding-on-how-to-configure-the-development-server.">Deciding on how to configure the Development Server.</h2><p>I realise that I should be using something like <a href="https://puppetlabs.com/">Puppet</a> or <a href="http://www.opscode.com/chef/">Chef</a> but every time I start researching what is involved they seem overly complicated for my purposes. I'm very capable of doing bits of server admin but figuring out either of those seems too much. I'm mostly a developer so I want something to support my code/configuration, I'm not looking to change profession.</p><p>Eventually in my research I came across <a href="http://en.wikipedia.org/wiki/Comparison_of_open_source_configuration_management_software">this Wikipedia article</a> and looked at the table deciding what I wanted... I wanted something that is still being actively maintained, of those I might as well go for one that supports &quot;Verify Mode&quot; as it just seemed like a good idea, so now the list of possibles is down to four! I noticed that <a href="http://ansible.cc/">Ansible</a> &quot;Manages nodes over SSH and does not require any additional remote software to be installed on them&quot;.... Wow that seems perfect, I trust SSH with my whole life, so I'm fine trusting it with my servers!</p><h2 id="installing-ansible">Installing Ansible</h2><p>So I read through the <a href="http://ansible.cc/docs/gettingstarted.html">Getting Started</a> documentation and decided to give it a go... It's always worth looking to see if there's a package for any software you're going to install already in the Ubuntu repositories, but there wasn't.</p><pre><code>    me@laptop:~/Projects/syncitserv $ apt-cache search ansible</code></pre><p>No big deal... They supply a PPA for easy installation</p><pre><code>    root@laptop:/home/me/Projects/syncitserv# add-apt-repository ppa:rquillo/ansible<br />    root@laptop:/home/me/Projects/syncitserv# apt-get update<br />    root@laptop:/home/me/Projects/syncitserv# apt-cache search ansible</code></pre><p>ansible - Ansible Application root@laptop:/home/me/Projects/syncitserv# sudo apt-get install ansible</p><h2 id="installed...-what-now">Installed... What now?</h2><p>Let's see what we have</p><pre><code>    me@laptop:~/Projects/syncitserv $ ansible[TAB][TAB]<br />    ansible           ansible-doc       ansible-playbook  ansible-pull</code></pre><p>A few programs</p><pre><code>    me@laptop:~/Projects/syncitserv $ ansible --help<br />    Usage: ansible &lt;host-pattern&gt; [options]<br /><br />    Options:<br />      -a MODULE_ARGS, --args=MODULE_ARGS<br />                            module arguments<br />      -k, --ask-pass        ask for SSH password<br />      -K, --ask-sudo-pass   ask for sudo password<br />      -B SECONDS, --background=SECONDS<br />                            run asynchronously, failing after X seconds<br />                            (default=N/A)<br />      -c CONNECTION, --connection=CONNECTION<br />                            connection type to use (default=paramiko)<br />      -f FORKS, --forks=FORKS<br />                            specify number of parallel processes to use<br />                            (default=5)<br />      -h, --help            show this help message and exit<br />      -i INVENTORY, --inventory-file=INVENTORY<br />                            specify inventory host file<br />                            (default=/etc/ansible/hosts)<br />      -l SUBSET, --limit=SUBSET<br />                            further limit selected hosts to an additional pattern<br />      --list-hosts          dump out a list of hosts matching input pattern, does<br />                            not execute any modules!<br />      -m MODULE_NAME, --module-name=MODULE_NAME<br />                            module name to execute (default=command)<br />      -M MODULE_PATH, --module-path=MODULE_PATH<br />                            specify path(s) to module library<br />                            (default=/usr/share/ansible/)<br />      -o, --one-line        condense output<br />      -P POLL_INTERVAL, --poll=POLL_INTERVAL<br />                            set the poll interval if using -B (default=15)<br />      --private-key=PRIVATE_KEY_FILE<br />                            use this file to authenticate the connection<br />      -s, --sudo            run operations with sudo (nopasswd)<br />      -U SUDO_USER, --sudo-user=SUDO_USER<br />                            desired sudo user (default=root)<br />      -T TIMEOUT, --timeout=TIMEOUT<br />                            override the SSH timeout in seconds (default=10)<br />      -t TREE, --tree=TREE  log output to this directory<br />      -u REMOTE_USER, --user=REMOTE_USER<br />                            connect as this user (default=me)<br />      -v, --verbose         verbose mode (-vvv for more)<br />      --version             show program&#39;s version number and exit</code></pre><p>And it does at least run too, great :-)</p><p>The documentation wants you to setup a <code>/etc/ansible/hosts</code> file, which to me seems a bit overkill. I will do work for my full time job on this laptop and work on a few personal projects, so having a centralized list of servers, which require root to edit, does not seem like the right idea. I wanted an <code>ansible/hosts</code> file per project, thankfully it supports it with the <code>-i INVENTORY</code> option.</p><pre><code>    me@laptop:~/Projects/syncitserv $ mkdir ansible<br />    me@laptop:~/Projects/syncitserv $ cd ansible/<br />    me@laptop:~/Projects/syncitserv/ansible $ echo &#39;192.168.122.249&#39; &gt; _etc_ansible_hosts<br /><br />    me@laptop:~/Projects/syncitserv/ansible $ ansible all -m ping -i _etc_ansible_hosts <br />    192.168.122.249 | FAILED =&gt; FAILED: ssh me@192.168.122.249:22 : Private key file is encrypted<br />    To connect as a different user, use -u &lt;username&gt;.</code></pre><p>But it does not yet respond to ping requests... But of course, that's the wrong username.</p><pre><code>    me@laptop:~/Projects/syncitserv/ansible $ ansible all -m ping -i _etc_ansible_hosts  -u theadmin<br />    192.168.122.249 | success &gt;&gt; {<br />        &quot;changed&quot;: false, <br />        &quot;ping&quot;: &quot;pong&quot;<br />    }</code></pre><p>Will it work with <code>sudo</code> for root?</p><pre><code>    me@laptop:~/Projects/syncitserv/ansible $ ansible all -m ping -i _etc_ansible_hosts  -u theadmin --sudo<br />    ^C<br />    ERROR: interupted</code></pre><p>Nope, not straight away anyway.</p><pre><code>    me@laptop:~/Projects/syncitserv/ansible $  -K<br />    sudo password: <br />    192.168.122.249 | success &gt;&gt; {<br />        &quot;changed&quot;: false, <br />        &quot;ping&quot;: &quot;pong&quot;<br />    }</code></pre><p>But passing in <code>-K</code> will prompt me for a password, though I don't think that's the press a button to deploy a server option that I want...</p><p>Added a sudo record on the new server to stop it asking me for passwords</p><pre><code>    root@server:/home/theadmin# echo &#39;theadmin ALL=(ALL) NOPASSWD: ALL&#39; &gt; /etc/sudoers.d/theadmin_has_sudo</code></pre><p>Try again...</p><pre><code>    me@laptop:~/Projects/syncitserv/ansible $ ansible all -m ping -i _etc_ansible_hosts  -u theadmin --sudo<br />    192.168.122.249 | success &gt;&gt; {<br />        &quot;changed&quot;: false, <br />        &quot;ping&quot;: &quot;pong&quot;<br />    }</code></pre><p>So lets see if we can actually run commands...</p><pre><code>    me@laptop:~/Projects/syncitserv/ansible $ ansible all -i _etc_ansible_hosts -u theadmin --sudo -m command -a &#39;ls /&#39;<br />    192.168.122.249 | success | rc=0 &gt;&gt;<br />    bin<br />    boot<br />    dev<br />    etc<br />    home<br />    initrd.img<br />    initrd.img.old<br />    lib<br />    lib64<br />    lost+found<br />    media<br />    mnt<br />    opt<br />    proc<br />    root<br />    run<br />    sbin<br />    selinux<br />    srv<br />    sys<br />    tmp<br />    usr<br />    var<br />    vmlinuz<br />    vmlinuz.old</code></pre><h2 id="doing-something-useful">Doing something useful</h2><p>That's a lot of progress with nothing actually achieved, except learning, I think it's always important to get a real step closer to your goal when learning something new. The <a href="http://ansible.cc/docs/gettingstarted.html">getting started</a> documentation has a link to <a href="http://ansible.cc/docs/examples.html">Command Line Examples And Next Steps</a> and on there it has a trivial example of using copying a file, but it introduces the concept of modules.</p><pre><code>    $ ansible atlanta -m copy -a &quot;src=/etc/hosts dest=/tmp/hosts&quot;</code></pre><p>Modules area is really where Ansible becomes useful. I wanted to see if I could install mongodb. I visited the <a href="http://ansible.cc/docs/modules.html">modules page</a> and saw there was an <a href="http://ansible.cc/docs/modules.html#apt"><code>apt</code></a> command and it takes a few parameters, <code>pkg</code> looks like what I need. Looking at the copy example above it seems like <code>src</code> and <code>dest</code> are keys with <code>/etc/hosts</code> and <code>/tmp/hosts</code> being parameters so substituting my <code>pkg</code> in I get the command:</p><pre><code>    me@laptop:~/Projects/syncitserv/ansible $ ansible all --sudo -i _etc_ansible_hosts  -u theadmin -m apt -a &#39;pkg=mongodb<br />    192.168.122.249 | success &gt;&gt; {<br />        &quot;changed&quot;: true<br />    }</code></pre><p>Success!</p>
